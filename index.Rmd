---
title: "SURVIVAL ANALYSIS  IN R"
output: 
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
date: 'BY :     Kikonyogo Steven'
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




  
  
  

![](C:/Users/steven\Desktop\survival.png)



## WHAT IS SURVIVAL ANALYSIS ?

*Survival analysis* focuses on describing for a given individual or group of individuals, a defined point of event called ***the failure*** ( such as occurrence of a disease, cure from a disease, death, relapse after response to treatment...) that occurs after a period of time called ***failure time*** during which individuals are observed. It is usually expressed through the ***survival probability*** which is the probability that the event of interest has not occurred by a duration, t.

In short, survival data can be described as having the following three characteristics:

1.  the dependent variable or response is the waiting time until the occurrence of a well-defined event,

2.  observations can be censored, in the sense that for some units the event of interest has not occurred at the time the data are analyzed, and

3.  there are predictors or explanatory variables whose effect on the waiting time we wish to assess or control.

### **About the project**

The data set is of adjuvant chemotherapy for 888 colon cancer patients. We will focus on the study effect of treatment types on time to death. We shall visualize the data with kaplan-meier estimate of the survival function and the corresponding 95% confidence intervals. We shall fit a cox hazards proportional model, compare survival experiences and test their significance using the log rank test.You can find [here](https://www.kaggle.com/datasets/lakshmi25npathi/colon-cancer) the link to the data set.

### **Loading packages**

```{r}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
              gt,
              rio,
              here,
              dplyr,
              ggplot2,
              magrittr,
              janitor,
              survival,
              flextable
              )
          
```

### **Importing data into R**

```{r}
DF <- rio::import(here("C:/Users/steven/Desktop/PROJECTS/colon.csv"))
  DF %>% 
  select(
         time,
         age) %>% 
  mutate(
         follow_up=time/365) %>% 
  summary()
  
 DF1 <- subset(DF,rx >= 2) 

```

### **Data Exploration**
```{r, set_flextable_defaults(fonts_ignore=TRUE)}
colon <- DF1 %>% 
     select(
         time,
         status,
         rx,
         age,
         sex) %>% 
    mutate(
          follow_up=time/365,  
          event = ifelse(status==1, "death", "censored"),
          trt_ype  = ifelse(rx==2, "amisole", "amisole+5-FU"),
          gender = ifelse(sex == 1, "male", "female"),
          age_cat = case_when(
          age < 35 ~ "0 - 34",
          age >= 35 & age < 65 ~ "35 - 64",
          age >= 65 ~ "65+")
          )

any(is.na(colon))
str(colon)

head(colon,10)
tabyl(colon$gender)
tabyl(colon$trt_ype)
tabyl(colon$age_cat)
tabyl(colon$event)

colon %>% 
  tabyl(gender, age_cat) %>% 
  adorn_totals(where = "both") %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns(position = "front") %>% 
  gt()

colon %>% 
  tabyl(gender, event) %>% 
  adorn_totals(where = "both") %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns(position = "front") %>% 
  flextable()

colon %>% 
  tabyl(age_cat, event) %>% 
  adorn_totals(where = "both") %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns(position = "front") %>% 
  gt()


colon %>% 
  tabyl(trt_ype, event) %>% 
  adorn_totals(where = "both") %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns(position = "front") %>% 
  flextable()
              

```

*Of the 888 patients, 594 were randomly allocated to the two treatments and of these, 298 were females(50.2%) and 296 males(49.8%).*

*305(51.3%) received old treatment while 289(48.7%) received new treatment. The minimum age was 18yrs and maximum was 85yrs.*

*At the end of the study, there were 285 deaths(48%) and 309 censored(52%).Of the deaths, 149(52.3%) were females and 136(47.7%) males.Majority of the deaths were from the old treatment(56.4%) compared to new treatment(39.1%)*

### **Fitting Overall survival curve**

```{r, fig.align='center', 
fig.cap="Figure1:Overall survival curve"}
survobj <- Surv(time = colon$follow_up,
                event = colon$status)

 head(survobj, 10)
 fitkm <- survfit(survobj ~ 1 )
 plot(fitkm,
      xlab = "Time (in years) of follow up",
      ylab = "Survival probability",
      main = "Kaplan-meier Overall survival curve ",
      col="red"
      )
 
```

### **Compare survival between groups**

```{r,}
colo <- c("blue", "darkgreen")

colon_gender <- survfit(Surv
                        (follow_up,status) ~sex,
                        data =colon)
 
 #Survival curves for male and female 
 plot(
   colon_gender,
   col = colo,
   xlab = "Time(in years)of years of follow up",
   ylab = "Survival probability",
   main = "Survival curves by gender"
   )
  legend(
    "topright",
  legend = c("female", "male"),
  col = colo,
   lty = 1,
   cex = .9,
   bty = "n"
   )
  
 #Test for difference in survival in gender
coxfit_gender <- coxph(Surv
                       (follow_up,status)~gender,                          data=colon)
summary(coxfit_gender)
 
survdiff(Surv
        (follow_up,status) ~ gender,data = colon)

# Survival curves for  two treatment types 
colon_trt <- survfit(
                  Surv(follow_up,status) ~
                    trt_ype,data =colon)

plot(
  colon_trt,
  col = colo,
  xlab = "Time(in years)of years of follow up",
  ylab = "Survival probability",
  main = "Survival curves by Treatment type")
legend(
  "topright",
  legend = c("lev(amisole)","lev(amisole)+5-FU"),
  col = colo,
  lty = 1,
  cex = .9,
  bty = "n"
  )

#Test for difference in survival between treatments
coxfit_trt <- coxph(
              Surv(follow_up,status)~trt_ype,
              data=colon)
summary(coxfit_trt)
survdiff(Surv
        (follow_up,status) ~ trt_ype,data = colon)

#Survival curves for age categories 
colon_age_cat <- survfit(
                 Surv(follow_up,status) ~ age_cat ,                  data =colon)
col_age <- c("blue", "darkgreen", "red")

plot(
  colon_age_cat,
  col = col_age,
  xlab = "Time(in years)of years of follow up",
  ylab = "Survival probability",
  main = "Survival curves by Age category")
legend(
  "topright",
  legend = c("65+","35-64","0-34"),
  col = col_age,
  lty = 1,
  cex = .9,
  bty = "n"
  )

#Test for difference in survival in age categories
coxfit_age_cat <- coxph(
                  Surv(follow_up,status) ~ age_cat,
                  data=colon)
summary(coxfit_age_cat)
survdiff(
      Surv(follow_up,status) ~ age_cat,data = colon)


```

-   ***Gender**** **:**There is no statistically significant difference in survival between males and females(p=0.2). The HR=0.85, indicates that patients who are male have a reduced risk of death(by 15%) compared to females.The 95% C.I is (0.677-1.08) indicating that HR is not statistically different from 1*.

-   ***AGE CATEGORY*** **:** *There is no statistically significant difference in survival among the age categories(p=0.4).The HR for 35-64(HR=0.71) indicates that patients in this category have a reduced risk of death(by 29%) compared to age category 0-34.The 95% C.I is (0.393-1.27) indicating that HR is not statistically different from 1. The HR for 65+(HR=0.67) indicates that patients in this category have a reduced risk of death(by 33%) compared to age category 0-34.The 95% C.I is (0.37-1.21) indicating that HR is not statistically different from 1*

-   ***TREATMENT TYPES*** **:** *There is a statistically significant difference in survival between the old and new treatment(p\<0.05). The HR=0.6, indicates that patients who received the new treatment have a reduced risk of death(by 40%) compared to those who received old treatment.The 95% C.I is (0.47-0.75) indicating that HR is statistically different from 1.*

### **Cox Regression analysis**

```{r}
colon_cox_sexagecat <- coxph(
                         Surv(follow_up,status) ~
                           gender + age_cat, 
                         data = colon
                         )

colon_cox_sexagecat
test.colon_cox_sexagecat <- cox.zph(                                            colon_cox_sexagecat)
test.colon_cox_sexagecat 

colon_cox_sextrt <- coxph(
                      Surv(follow_up,status) ~
                        gender + trt_ype, 
                      data = colon
                      )

colon_cox_sextrt
test_colon_coxsextrt <- cox.zph(colon_cox_sextrt)
test_colon_coxsextrt


#fit the model
colon_surv_cox <-  coxph(
                   Surv(follow_up, status) ~  
                     gender + age + trt_ype,
                   data = colon
                   )
 summary(colon_surv_cox)

#test the proportional hazard model
colon_surv_cox_ph_test <- cox.zph(colon_surv_cox)
colon_surv_cox_ph_test
```
